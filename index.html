<!-- 中略：ヘッダー・スタイルは前回と同じ -->

<div class="wrap">
  <!-- プレビュー -->
  <div class="preview-area">
    <img id="previewImage" alt="プレビュー画像">
    <div class="preview-note">プレビューを見ながら設定してください。長押しで保存（スマホ）</div>
  </div>

  <!-- 画像切替ボタン -->
  <div class="controls">
    <div class="field">
      <label>ベース画像選択</label>
      <div style="display:flex;gap:10px;">
        <button type="button" class="base-btn" data-src="base1.png">画像1</button>
        <button type="button" class="base-btn" data-src="base2.png">画像2</button>
      </div>
    </div>

    <!-- 文字設定は以前の通り -->
    <div class="field">
      <label for="textInput">文字</label>
      <input id="textInput" type="text" value="サンプル文字">
    </div>

    <div class="field">
      <label for="fontSelect">書体</label>
      <select id="fontSelect">
        <!-- 英字 -->
        <option value="Montserrat">Montserrat</option>
        <option value="Lora">Lora</option>
        <option value="Poppins">Poppins</option>
        <option value="Fredoka One">Fredoka One</option>
        <!-- 日本語 -->
        <option value="Kosugi Maru">Kosugi Maru</option>
        <option value="Noto Sans JP">Noto Sans JP</option>
        <option value="Baloo 2">Baloo 2</option>
        <option value="M PLUS Rounded 1c">M PLUS Rounded 1c</option>
      </select>
    </div>

    <div class="field">
      <label for="sizeRange">文字サイズ (px)</label>
      <div class="slider-wrap">
        <input id="sizeRange" type="range" min="10" max="800" value="120">
        <span class="slider-value" id="sizeVal">120</span>
      </div>
    </div>

    <div class="field">
      <label for="xRange">X座標 (px)</label>
      <div class="slider-wrap">
        <input id="xRange" type="range" min="0" max="1000" value="200">
        <span class="slider-value" id="xVal">200</span>
      </div>
    </div>

    <div class="field">
      <label for="yRange">Y座標 (px)</label>
      <div class="slider-wrap">
        <input id="yRange" type="range" min="0" max="1000" value="600">
        <span class="slider-value" id="yVal">600</span>
      </div>
    </div>

    <div class="field">
      <label>文字色</label>
      <div class="color-swatch">
        <input id="colorInput" type="color" value="#ff0000">
      </div>
    </div>
  </div>

  <!-- ダウンロードボタン -->
  <div class="download-area">
    <a id="downloadBtn" class="download" download="generated.png" href="#">ダウンロード</a>
  </div>
</div>

<canvas id="hiddenCanvas"></canvas>

<script>
const previewImage = document.getElementById('previewImage');
const hiddenCanvas = document.getElementById('hiddenCanvas');
const ctx = hiddenCanvas.getContext('2d');

const textInput = document.getElementById('textInput');
const fontSelect = document.getElementById('fontSelect');
const sizeRange = document.getElementById('sizeRange');
const xRange = document.getElementById('xRange');
const yRange = document.getElementById('yRange');
const sizeVal = document.getElementById('sizeVal');
const xVal = document.getElementById('xVal');
const yVal = document.getElementById('yVal');
const colorInput = document.getElementById('colorInput');
const downloadBtn = document.getElementById('downloadBtn');

let baseImg = new Image();
baseImg.src = 'base1.png'; // 初期画像

function drawToCanvas(){
  hiddenCanvas.width = baseImg.naturalWidth || baseImg.width;
  hiddenCanvas.height = baseImg.naturalHeight || baseImg.height;

  ctx.clearRect(0,0,hiddenCanvas.width,hiddenCanvas.height);
  ctx.drawImage(baseImg,0,0,hiddenCanvas.width,hiddenCanvas.height);

  ctx.textBaseline = 'top';
  ctx.fillStyle = colorInput.value;
  ctx.font = `${sizeRange.value}px "${fontSelect.value}", sans-serif`;
  ctx.fillText(textInput.value, parseInt(xRange.value,10), parseInt(yRange.value,10));
}

function drawAndUpdatePreview(){
  drawToCanvas();
  const dataUrl = hiddenCanvas.toDataURL('image/png');
  previewImage.src = dataUrl;
  downloadBtn.href = dataUrl;
}

// 自動更新
[textInput, fontSelect, sizeRange, xRange, yRange, colorInput].forEach(el => {
  el.addEventListener('input', drawAndUpdatePreview);
});

// スライダーの値表示更新
[sizeRange, xRange, yRange].forEach(range=>{
  range.addEventListener('input', ()=>{
    sizeVal.textContent = sizeRange.value;
    xVal.textContent = xRange.value;
    yVal.textContent = yRange.value;
  });
});

// ベース画像切替ボタン
document.querySelectorAll('.base-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    baseImg.src = btn.dataset.src;
    // 画像が切り替わったら即反映
    baseImg.onload = drawAndUpdatePreview;
  });
});

// 初回描画
window.addEventListener('load', drawAndUpdatePreview);

// これで全てのイベントリスナーは設定済みで、自動更新・ベース画像切替・スライダー表示更新・ダウンロードが機能します。
</script>
</body>
</html>
